<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><script>window.lsVersion="1.3.0",window.oldVersion=["0.2.0","0.0.1","0.1.0","1.0.0","1.0.1","1.1.0","1.1.1","1.2.0"]</script><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="//www.googletagmanager.com"><link rel="dns-prefetch" href="//www.google-analytics.com"><meta http-equiv="X-UA-Compatible" content="IE=Edge, chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><title>第一次用 Docker 自架 v2ray + shadowsocks 翻牆伺服器就上手 | Birkhoff&#39;s Blog</title><link rel="shortcut icon" type="image/ico" href="/img/suka-favicon.ico"><meta name="format-detection" content="telephone=no"><meta name="description" content="How It Works我們接下來將使用 v2ray 架設使用 VMess 與 ShadowSocks 協議翻墻的伺服器。我們主要將使用 VMess 進行翻墻..."><meta name="keywords" content=""><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>body{background-color:#f8f9fa}a,a:visited{color:#0070ff}a:active,a:focus,a:hover{color:#0070ff;opacity:.75}#post-content a,#post-content a:focus,#post-content a:hover,#post-content a:visited{color:#005eb9;opacity:1}.post-entry .card-body a{color:#0070ff}.avatar{background:#444}.navbar-link,.navbar-link:visited,.timeline .timeline-item .timeline-icon.icon-lg{color:#0070ff}.navbar-link:hover{color:#0070ff;opacity:.8}#disqus-loadmore-button,#disqus-switch-to-direct,#disqus_click_btn,#search-input .btn{background:#727e96;border-color:#727e96;color:#fff}#post-toc a.post-toc-link,#post-toc a.post-toc-link:visited,.share-menu.menu .menu-item>a{color:#727e96}.share-menu.menu .menu-item>a:focus,.share-menu.menu .menu-item>a:hover,.share-menu.menu .menu-item>a:visited{color:#50596c;background:#f8f9fa;opacity:.85}</style><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.0.6/dist/disqusjs.css"><link rel="stylesheet" href="/css/highlight/github.min.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="Birkhoff&#39;s Blog"><meta name="msapplication-starturl" content="https://blog.birkhoff.me"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Birkhoff&#39;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Birkhoff&#39;s Blog"><meta property="og:title" content="第一次用 Docker 自架 v2ray + shadowsocks 翻牆伺服器就上手 | Birkhoff&#39;s Blog"><meta property="og:site_name" content="Birkhoff&#39;s Blog"><meta property="og:locale" content="en"><meta property="og:url" content="https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/"><meta property="og:image" content="https://blog.birkhoff.me/img/suka-favicon.ico"><meta property="og:description" content="How It Works我們接下來將使用 v2ray 架設使用 VMess 與 ShadowSocks 協議翻墻的伺服器。我們主要將使用 VMess 進行翻墻..."><meta name="twitter:card" content="summary"><meta property="og:type" content="article"><meta property="article:published_time" content="2017-11-10T11:12:24.000Z"><meta property="article:modified_time" content="2017-11-10T11:12:24.000Z"><meta property="article:author" content="Birkhoff Lee"><meta property="og:article:tag" content=""><script async src="https://www.googletagmanager.com/gtag/js?id=UA-68379784-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","")</script><link rel="canonical" href="https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/"><script type="application/ld+json">{
    "@context": "http://schema.org",
    "url": "https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/",
    "@type": "BlogPosting",
    "logo": "https://blog.birkhoff.me/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/"
    },
    "headline": "第一次用 Docker 自架 v2ray + shadowsocks 翻牆伺服器就上手 | Birkhoff&#39;s Blog",
    
    "image": {
        "@type": "ImageObject",
        "url": "https://blog.birkhoff.me/img/suka-favicon.ico"
    },
    
    "datePublished": "2017-11-10T11:12:24.000Z",
    "dateModified": "2017-11-12T08:16:14.000Z",
    "author": {
        "@type": "Person",
        "name": "Birkhoff Lee",
        "image": {
            "@type": "ImageObject",
            "url": "https://blog.birkhoff.me/img/birkhoff.jpg"
        },
        "description": "Thoughts and technonogies."
    },
    "publisher": {
        "@type": "Organization",
        "name": "Birkhoff&#39;s Blog",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog.birkhoff.me/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https://blog.birkhoff.me/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "",
    "description": "How It Works我們接下來將使用 v2ray 架設使用 VMess 與 ShadowSocks 協議翻墻的伺服器。我們主要將使用 VMess 進行翻墻..."
}</script><script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script></head><body><header><h1 class="header-title text-center"><a href="/">Birkhoff&#39;s Blog</a></h1><p class="text-center header-slogan">Thoughts and technonogies.</p><nav class="navbar-section text-center"><a href="/" class="navbar-link">Home</a> <a href="/search" class="navbar-link">Search</a> <a href="/about/" class="navbar-link">About</a> <a href="/donate/" class="navbar-link">Donate</a> <a href="/atom.xml" class="navbar-link">Feed</a></nav></header><div class="post-container"><div id="post-card" class="card"><div class="card-item-container"><div class="card-inner-cell"><div class="card-header"><h1 class="card-title h3 mb-2">第一次用 Docker 自架 v2ray + shadowsocks 翻牆伺服器就上手</h1><div class="post-header-info"><p class="post-header-info-left text-gray"><img class="author-thumb lazyload" data-src="/img/birkhoff.jpg" alt="Birkhoff Lee's Avatar"> <span>November 10th 2017</span></p><div class="post-header-info-right"><div class="dropdown dropdown-right"><a class="dropdown-toggle" tabindex="0">Share</a><ul class="menu share-menu"><li class="menu-item"><a href="https://twitter.com/intent/tweet?text=第一次用 Docker 自架 v2ray + shadowsocks 翻牆伺服器就上手&url=https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/&via=Birkhoff Lee" target="_blank" rel="noopener noreferrer nofollow">Share to Twitter</a></li><li class="menu-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/" target="_blank" rel="noopener noreferrer nofollow">Share to Facebook</a></li><li class="menu-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/&title=Birkhoff's Blog" target="_blank" rel="noopener noreferrer nofollow">Share to LinkedIn</a></li><li class="menu-item"><a href="https://t.me/share/url?url=https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/&text=Birkhoff's Blog" target="_blank" rel="noopener noreferrer nofollow">Share to Telegram</a></li></ul></div></div></div></div><div class="card-body"><article id="post-content"><h2 id="How-It-Works"><a href="#How-It-Works" class="headerlink" title="How It Works"></a>How It Works</h2><p>我們接下來將使用 v2ray 架設使用 VMess 與 ShadowSocks 協議翻墻的伺服器。我們主要將使用 VMess 進行翻墻，ShadowSocks 僅作為備用。</p><p>VMess 部分我們將將流量偽裝成正常的 <strong>https</strong> 流量並使用 <strong>WebSocket</strong> 進行與 <code>nginx-proxy</code> 的通訊，由 <code>nginx-proxy</code> 進行 reverse proxying，SSL 憑證由 <code>jrcs/letsencrypt-nginx-proxy-companion</code> 自動向 <a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a> 申請並套用。</p><p>ShadowSocks 部分則使用<strong>原版協定</strong>，且<strong>不使用混淆參數</strong>。（v2ray 目前尚未實作這些部分，希望未來可以看到）</p><blockquote><p>Update: 目前還是推薦使用純 shadowsocks，使用 <code>chacha20-ietf-poly1305</code>（或 <code>xchacha20-ietf-poly1305</code>）、<code>origin</code> 協定、混淆使用 <code>simple_obfs_http</code></p></blockquote><h2 id="本文示範環境"><a href="#本文示範環境" class="headerlink" title="本文示範環境"></a>本文示範環境</h2><p>使用系統為 CentOS 7，採用 Google Cloud Platform 日本機房。<br>我將假設 v2ray 資料夾位於 <code>~/v2ray</code>，以下的檔案都將放置於此。</p><p><code>$ docker version</code>:<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Client:</span><br><span class="line">... (略)</span><br><span class="line">Server:</span><br><span class="line"> Version:      17.09.0-ce</span><br><span class="line"> API version:  1.32 (minimum version 1.12)</span><br><span class="line"> Go version:   go1.8.3</span><br><span class="line"> Git commit:   afdb6d4</span><br><span class="line"> Built:        Tue Sep 26 22:42:49 2017</span><br><span class="line"> OS/Arch:      linux/amd64</span><br><span class="line"> Experimental: false</span><br></pre></td></tr></table></figure><p></p><h2 id="前備條件"><a href="#前備條件" class="headerlink" title="前備條件"></a>前備條件</h2><p>Docker:<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">$ sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">$ sudo yum install -y docker-ce</span><br><span class="line">$ sudo systemctl start docker</span><br><span class="line">$ sudo usermod -aG docker $USER</span><br><span class="line">$ docker version</span><br></pre></td></tr></table></figure><p></p><p>docker-compose:<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo curl -L https://github.com/docker/compose/releases/download/1.17.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><span class="line">$ sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line">$ docker-compose --version</span><br></pre></td></tr></table></figure><p></p><p>下載/建立所需資料夾與檔案：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ mkdir -p ~/v2ray</span><br><span class="line">$ cd ~/v2ray</span><br><span class="line">$ curl -L https://raw.githubusercontent.com/jwilder/nginx-proxy/master/nginx.tmpl &gt; nginx.tmpl</span><br><span class="line">$ mkdir v2ray_logs</span><br><span class="line">$ mkdir -p ~/v2ray/nginx/vhost.d/</span><br></pre></td></tr></table></figure><p></p><p>另外，請將防火墻設定為允許下列規則的 ingress traffic（tcp/udp 都要）：</p><ul><li>nginx: 80, 443</li><li>ShadowSocks: 19477, 19478</li></ul><h2 id="撰寫-v2ray-設定檔"><a href="#撰寫-v2ray-設定檔" class="headerlink" title="撰寫 v2ray 設定檔"></a>撰寫 v2ray 設定檔</h2><p><code>config.json</code>:</p><ul><li>將 <code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code> 換為一個隨機的 UUID，你可以在這裡產生一個：<a href="https://www.uuidgenerator.net/" target="_blank" rel="noopener">https://www.uuidgenerator.net/</a></li><li>將 <code>[SOME_SECURE_PASSWORD]</code> 換為 ShadowSocks 的連線密碼，盡量超過 16 個字元。</li></ul><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"log"</span>: &#123;</span><br><span class="line">    <span class="attr">"access"</span>: <span class="string">"/var/log/v2ray/access.log"</span>,</span><br><span class="line">    <span class="attr">"error"</span>: <span class="string">"/var/log/v2ray/error.log"</span>,</span><br><span class="line">    <span class="attr">"loglevel"</span>: <span class="string">"warning"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"inbound"</span>: &#123;</span><br><span class="line">    <span class="attr">"port"</span>: <span class="number">19487</span>,</span><br><span class="line">    <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</span><br><span class="line">    <span class="attr">"settings"</span>: &#123;</span><br><span class="line">      <span class="attr">"clients"</span>: [&#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"</span>,</span><br><span class="line">        <span class="attr">"level"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"alterId"</span>: <span class="number">9487</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"streamSettings"</span>: &#123;</span><br><span class="line">      <span class="attr">"network"</span>: <span class="string">"ws"</span>,</span><br><span class="line">      <span class="attr">"wsSettings"</span>: &#123;</span><br><span class="line">        <span class="attr">"connectionReuse"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"path"</span>: <span class="string">"/"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"detour"</span>: &#123;</span><br><span class="line">      <span class="attr">"to"</span>: <span class="string">"vmess-detour"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"outbound"</span>: &#123;</span><br><span class="line">    <span class="attr">"protocol"</span>: <span class="string">"freedom"</span>,</span><br><span class="line">    <span class="attr">"settings"</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"inboundDetour"</span>: [&#123;</span><br><span class="line">      <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</span><br><span class="line">      <span class="attr">"port"</span>: <span class="string">"45000-45999"</span>,</span><br><span class="line">      <span class="attr">"tag"</span>: <span class="string">"vmess-detour"</span>,</span><br><span class="line">      <span class="attr">"settings"</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">"allocate"</span>: &#123;</span><br><span class="line">        <span class="attr">"strategy"</span>: <span class="string">"random"</span>,</span><br><span class="line">        <span class="attr">"concurrency"</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">"refresh"</span>: <span class="number">5</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"streamSettings"</span>: &#123;</span><br><span class="line">        <span class="attr">"network"</span>: <span class="string">"ws"</span>,</span><br><span class="line">        <span class="attr">"wsSettings"</span>: &#123;</span><br><span class="line">          <span class="attr">"connectionReuse"</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">"path"</span>: <span class="string">"/"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"protocol"</span>: <span class="string">"shadowsocks"</span>,</span><br><span class="line">      <span class="attr">"port"</span>: <span class="number">19477</span>,</span><br><span class="line">      <span class="attr">"settings"</span>: &#123;</span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"aes-256-cfb"</span>,</span><br><span class="line">        <span class="attr">"password"</span>: <span class="string">"[SOME_SECURE_PASSWORD]"</span>,</span><br><span class="line">        <span class="attr">"udp"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"level"</span>: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"protocol"</span>: <span class="string">"shadowsocks"</span>,</span><br><span class="line">      <span class="attr">"port"</span>: <span class="number">19478</span>,</span><br><span class="line">      <span class="attr">"settings"</span>: &#123;</span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"aes-256-cfb"</span>,</span><br><span class="line">        <span class="attr">"password"</span>: <span class="string">"[SOME_SECURE_PASSWORD]"</span>,</span><br><span class="line">        <span class="attr">"udp"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"level"</span>: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"outboundDetour"</span>: [&#123;</span><br><span class="line">    <span class="attr">"protocol"</span>: <span class="string">"blackhole"</span>,</span><br><span class="line">    <span class="attr">"settings"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"tag"</span>: <span class="string">"blocked"</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">"routing"</span>: &#123;</span><br><span class="line">    <span class="attr">"strategy"</span>: <span class="string">"rules"</span>,</span><br><span class="line">    <span class="attr">"settings"</span>: &#123;</span><br><span class="line">      <span class="attr">"rules"</span>: [&#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"field"</span>,</span><br><span class="line">        <span class="attr">"ip"</span>: [</span><br><span class="line">          <span class="string">"0.0.0.0/8"</span>,</span><br><span class="line">          <span class="string">"10.0.0.0/8"</span>,</span><br><span class="line">          <span class="string">"100.64.0.0/10"</span>,</span><br><span class="line">          <span class="string">"127.0.0.0/8"</span>,</span><br><span class="line">          <span class="string">"169.254.0.0/16"</span>,</span><br><span class="line">          <span class="string">"172.16.0.0/12"</span>,</span><br><span class="line">          <span class="string">"192.0.0.0/24"</span>,</span><br><span class="line">          <span class="string">"192.0.2.0/24"</span>,</span><br><span class="line">          <span class="string">"192.168.0.0/16"</span>,</span><br><span class="line">          <span class="string">"198.18.0.0/15"</span>,</span><br><span class="line">          <span class="string">"198.51.100.0/24"</span>,</span><br><span class="line">          <span class="string">"203.0.113.0/24"</span>,</span><br><span class="line">          <span class="string">"::1/128"</span>,</span><br><span class="line">          <span class="string">"fc00::/7"</span>,</span><br><span class="line">          <span class="string">"fe80::/10"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"outboundTag"</span>: <span class="string">"blocked"</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="設定-docker-compose-以快速部署"><a href="#設定-docker-compose-以快速部署" class="headerlink" title="設定 docker-compose 以快速部署"></a>設定 docker-compose 以快速部署</h2><p><code>docker-compose.yml</code>:</p><ul><li>將 <code>v2ray.example.com</code> 換為你的網域名稱</li><li>將 <a href="mailto:`michael@example.com" target="_blank" rel="noopener">`michael@example.com</a>` 換為你的 email，接收憑證過期提醒用，不需認證</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  v2ray:</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">v2ray</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">v2ray/official</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">v2ray</span> <span class="bullet">-config=/etc/v2ray/config.json</span></span><br><span class="line"><span class="attr">    expose:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"19487"</span> <span class="comment"># v2ray port</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"19477-19478:19477-19478"</span> <span class="comment"># ShadowSocks</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"19487:19487"</span> <span class="comment"># v2ray port</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"19477-19478:19477-19478/udp"</span> <span class="comment"># ShadowSocks</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"19487:19487/udp"</span> <span class="comment"># v2ray port</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./v2ray_logs:/var/log/v2ray/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./config.json:/etc/v2ray/config.json:ro</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"VIRTUAL_HOST=v2ray.example.com"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"VIRTUAL_PORT=19487"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"LETSENCRYPT_HOST=v2ray.example.com"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"LETSENCRYPT_EMAIL=michael@example.com"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  nginx:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    labels:</span></span><br><span class="line">      <span class="string">com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"80:80"</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"443:443"</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/vhost.d:/etc/nginx/vhost.d</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/html:/usr/share/nginx/html</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/certs:/etc/nginx/certs:ro</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  nginx-gen:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">jwilder/docker-gen</span></span><br><span class="line"><span class="attr">    command:</span> <span class="bullet">-notify-sighup</span> <span class="string">nginx</span> <span class="bullet">-watch</span> <span class="bullet">-wait</span> <span class="number">5</span><span class="attr">s:30s</span> <span class="string">/etc/docker-gen/templates/nginx.tmpl</span> <span class="string">/etc/nginx/conf.d/default.conf</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">nginx-gen</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/vhost.d:/etc/nginx/vhost.d</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/html:/usr/share/nginx/html</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/certs:/etc/nginx/certs:ro</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/run/docker.sock:/tmp/docker.sock:ro</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx.tmpl:/etc/docker-gen/templates/nginx.tmpl:ro</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  nginx-letsencrypt:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">jrcs/letsencrypt-nginx-proxy-companion</span></span><br><span class="line"><span class="attr">    container_name:</span> <span class="string">nginx-letsencrypt</span></span><br><span class="line"><span class="attr">    restart:</span> <span class="string">unless-stopped</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/vhost.d:/etc/nginx/vhost.d</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/html:/usr/share/nginx/html</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./nginx/certs:/etc/nginx/certs:rw</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock:ro</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      NGINX_DOCKER_GEN_CONTAINER:</span> <span class="string">"nginx-gen"</span></span><br><span class="line"><span class="attr">      NGINX_PROXY_CONTAINER:</span> <span class="string">"nginx"</span></span><br></pre></td></tr></table></figure><h2 id="新增-nginx-virtual-host-設定檔"><a href="#新增-nginx-virtual-host-設定檔" class="headerlink" title="新增 nginx virtual host 設定檔"></a>新增 nginx virtual host 設定檔</h2><p>在 <code>~/v2ray/nginx/vhost.d/</code> 下建立名為 <code>你的網域名稱_location</code> 的檔案</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxy_redirect off;</span><br><span class="line">proxy_http_version 1.1;</span><br><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">proxy_set_header Host $http_host;</span><br><span class="line">if ($http_upgrade = &quot;websocket&quot; ) &#123;</span><br><span class="line">    proxy_pass http://v2ray:19487;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ docker-compose up -d</span><br><span class="line">$ docker-compose logs -f</span><br></pre></td></tr></table></figure><p>這會啟動 v2ray 並開始輸出日誌（按 Ctrl+C 退出）。</p><h2 id="設定-v2ray-client"><a href="#設定-v2ray-client" class="headerlink" title="設定 v2ray client"></a>設定 v2ray client</h2><ul><li>到 <a href="https://www.v2ray.com/chapter_01/3rd_party.html" target="_blank" rel="noopener">https://www.v2ray.com/chapter_01/3rd_party.html</a> 尋找一個喜歡的 client，下載並安裝</li><li>進入 server 設定畫面，填寫你伺服器的 IP address，port 為 <code>443</code></li><li>User ID 或 UUID 請填寫你修改的 UUID</li><li>alterId 請修改為 <code>9487</code></li><li>加密方式選擇 <code>aes-128-cfb</code></li><li>傳輸協定使用 <code>WebSocket</code>，path 指定為 <code>/</code></li></ul><h2 id="設定-ShadowSocks-client"><a href="#設定-ShadowSocks-client" class="headerlink" title="設定 ShadowSocks client"></a>設定 ShadowSocks client</h2><ul><li>在 Google 尋找一個喜歡的 ShadowSocks client，下載並安裝</li><li>進入 server 設定畫面，填寫你伺服器的 IP address，port 為 <code>19477</code> 或 <code>19478</code>，隨便挑一個</li><li>Password 填寫你指定的密碼</li><li>加密方式選擇 <code>aes-256-cfb</code></li><li>傳輸協定與混淆（Protocol 與 Obfs） 選擇 <code>origin</code> 與 <code>plain</code>，兩個 Param 都不填</li><li>UDP 可開啟</li></ul><h2 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h2><p>這樣應該就沒問題了，至於 v2ray 那邊有自動切換 port 的部分我還沒測試，以上設定檔是使用 <a href="https://htfy96.github.io/v2ray-config-gen" target="_blank" rel="noopener">https://htfy96.github.io/v2ray-config-gen</a> 產生的設定檔進行修改的，應該沒什麼大問題，還請協助測試。</p></article><p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2017-11-10T11:12:24.000Z" itemprop="datePublished">November 10th 2017</time>, updated at&nbsp;<time datetime="2017-11-12T08:16:14.000Z" itemprop="dateModified">November 12th 2017</time> .</p><p class="post-footer-info mb-0 pt-2"></p></div><div class="post-nav px-2 bg-gray"><ul class="pagination"><li class="page-item page-prev"><a href="/install-archisteamfarm-on-centos-7/"><div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div><div class="page-item-subtitle">在 CentOS 7 上使用 ArchiSteamFarm（ASF）達成 Steam 自動掛卡</div></a></li><li class="page-item page-next"><a href="/docker-aufs-solution/"><div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div><div class="page-item-subtitle">解決 apt-get dist-upgrade 並 reboot 之後 Docker daemon 無法啟動的問題</div></a></li></ul></div><div class="card-footer post-comment"><div id="disqus_thread"></div><script src="https://cdn.jsdelivr.net/npm/disqusjs@1.0.6/dist/disqus.js"></script><script>var dsqjs=new DisqusJS({shortname:"birkhoff",identifier:"https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/",url:"https://blog.birkhoff.me/use-docker-to-deploy-vmess-and-ss-using-docker/",api:"",apikey:"k71pSDWqRW7T6zNLNcz2h9gEc3AuWTO5bwIjy02UJWfCO8GlPUiGQt9vb6SiDVtP",admin:"birkhofflee"})</script></div></div></div></div></div><footer class="text-center"><p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span data-year=""></span> <a class="footer-copyright-a" href="https://blog.birkhoff.me">Birkhoff&#39;s Blog</a></p><p class="footer-text mb-0"></p><p class="footer-develop mb-0">Powered by&nbsp;<a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="noopener">Suka</a></p></footer><script>window.lazyLoadOptions={elements_selector:".lazyload",threshold:50};var copyrightNow=(new Date).getFullYear(),copyrightContent=document.querySelector("span[data-year]");copyrightSince=2015,copyrightSince===copyrightNow?copyrightContent.textContent=copyrightNow:copyrightContent.textContent=copyrightSince+" - "+copyrightNow,console.log("\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.0 %c https://github.com/SukkaW/hexo-theme-suka \n","color: #fff; background: #444; padding:5px 0;","background: #bbb; padding:5px 0;")</script><script src="/lib/vanilla-lazyload/lazyload.min.js" async></script></body></html>