<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><script>window.lsVersion="1.3.0",window.oldVersion=["0.2.0","0.0.1","0.1.0","1.0.0","1.0.1","1.1.0","1.1.1","1.2.0"]</script><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="//www.googletagmanager.com"><link rel="dns-prefetch" href="//www.google-analytics.com"><meta http-equiv="X-UA-Compatible" content="IE=Edge, chrome=1"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><title>Running Clash on OpenWrt as a transparent proxy | Birkhoff&#39;s Blog</title><link rel="shortcut icon" type="image/ico" href="/img/suka-favicon.ico"><meta name="format-detection" content="telephone=no"><meta name="description" content="As you would have been aware of that I live in China where internet is under strict censorship. I’ve been discovering ways to access the blocked internet resources."><meta name="keywords" content=""><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>body{background-color:#f8f9fa}a,a:visited{color:#0070ff}a:active,a:focus,a:hover{color:#0070ff;opacity:.75}#post-content a,#post-content a:focus,#post-content a:hover,#post-content a:visited{color:#005eb9;opacity:1}.post-entry .card-body a{color:#0070ff}.avatar{background:#444}.navbar-link,.navbar-link:visited,.timeline .timeline-item .timeline-icon.icon-lg{color:#0070ff}.navbar-link:hover{color:#0070ff;opacity:.8}#disqus-loadmore-button,#disqus-switch-to-direct,#disqus_click_btn,#search-input .btn{background:#727e96;border-color:#727e96;color:#fff}#post-toc a.post-toc-link,#post-toc a.post-toc-link:visited,.share-menu.menu .menu-item>a{color:#727e96}.share-menu.menu .menu-item>a:focus,.share-menu.menu .menu-item>a:hover,.share-menu.menu .menu-item>a:visited{color:#50596c;background:#f8f9fa;opacity:.85}</style><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.0.6/dist/disqusjs.css"><link rel="stylesheet" href="/css/highlight/github.min.css"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="Birkhoff&#39;s Blog"><meta name="msapplication-starturl" content="https://blog.birkhoff.me"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Birkhoff&#39;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="Birkhoff&#39;s Blog"><meta property="og:title" content="Running Clash on OpenWrt as a transparent proxy | Birkhoff&#39;s Blog"><meta property="og:site_name" content="Birkhoff&#39;s Blog"><meta property="og:locale" content="en"><meta property="og:url" content="https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/"><meta property="og:image" content="https://blog.birkhoff.me/img/suka-favicon.ico"><meta property="og:description" content="As you would have been aware of that I live in China where internet is under strict censorship. I’ve been discovering ways to access the blocked internet resources."><meta name="twitter:card" content="summary"><meta property="og:type" content="article"><meta property="article:published_time" content="2019-01-18T18:49:55.000Z"><meta property="article:modified_time" content="2019-01-18T18:49:55.000Z"><meta property="article:author" content="Birkhoff Lee"><meta property="og:article:tag" content=""><script async src="https://www.googletagmanager.com/gtag/js?id=UA-68379784-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","")</script><link rel="canonical" href="https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/"><script type="application/ld+json">{
    "@context": "http://schema.org",
    "url": "https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/",
    "@type": "BlogPosting",
    "logo": "https://blog.birkhoff.me/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/"
    },
    "headline": "Running Clash on OpenWrt as a transparent proxy | Birkhoff&#39;s Blog",
    
    "image": {
        "@type": "ImageObject",
        "url": "https://blog.birkhoff.me/img/suka-favicon.ico"
    },
    
    "datePublished": "2019-01-18T18:49:55.000Z",
    "dateModified": "2020-02-20T13:04:37.064Z",
    "author": {
        "@type": "Person",
        "name": "Birkhoff Lee",
        "image": {
            "@type": "ImageObject",
            "url": "https://blog.birkhoff.me/img/birkhoff.jpg"
        },
        "description": "Thoughts and technonogies."
    },
    "publisher": {
        "@type": "Organization",
        "name": "Birkhoff&#39;s Blog",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog.birkhoff.me/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https://blog.birkhoff.me/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "",
    "description": "As you would have been aware of that I live in China where internet is under strict censorship. I’ve been discovering ways to access the blocked internet resources."
}</script><script src="//instant.page/1.1.0" type="module" integrity="sha384-EwBObn5QAxP8f09iemwAJljc+sU+eUXeL9vSBw1eNmVarwhKk2F9vBEpaN9rsrtp"></script></head><body><header><h1 class="header-title text-center"><a href="/">Birkhoff&#39;s Blog</a></h1><p class="text-center header-slogan">Thoughts and technonogies.</p><nav class="navbar-section text-center"><a href="/" class="navbar-link">Home</a> <a href="/search" class="navbar-link">Search</a> <a href="/about/" class="navbar-link">About</a> <a href="/donate/" class="navbar-link">Donate</a> <a href="/atom.xml" class="navbar-link">Feed</a></nav></header><div class="post-container"><div id="post-card" class="card"><div class="card-item-container"><div class="card-inner-cell"><div class="card-header"><h1 class="card-title h3 mb-2">Running Clash on OpenWrt as a transparent proxy</h1><div class="post-header-info"><p class="post-header-info-left text-gray"><img class="author-thumb lazyload" data-src="/img/birkhoff.jpg" alt="Birkhoff Lee's Avatar"> <span>January 19th 2019</span></p><div class="post-header-info-right"><div class="dropdown dropdown-right"><a class="dropdown-toggle" tabindex="0">Share</a><ul class="menu share-menu"><li class="menu-item"><a href="https://twitter.com/intent/tweet?text=Running Clash on OpenWrt as a transparent proxy&url=https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/&via=Birkhoff Lee" target="_blank" rel="noopener noreferrer nofollow">Share to Twitter</a></li><li class="menu-item"><a href="https://www.facebook.com/sharer/sharer.php?u=https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/" target="_blank" rel="noopener noreferrer nofollow">Share to Facebook</a></li><li class="menu-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/&title=Birkhoff's Blog" target="_blank" rel="noopener noreferrer nofollow">Share to LinkedIn</a></li><li class="menu-item"><a href="https://t.me/share/url?url=https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/&text=Birkhoff's Blog" target="_blank" rel="noopener noreferrer nofollow">Share to Telegram</a></li></ul></div></div></div></div><div class="card-body"><article id="post-content"><p>As you would have been aware of that I live in China where internet is under strict censorship. I’ve been discovering ways to access the blocked internet resources.<br><a id="more"></a></p><p>So recently I switched to a x86 mini computer that runs Proxmox VE, which has an OpenWRT VM running as a router. In this blog post, I’m using <a href="https://github.com/Dreamacro/clash" target="_blank" rel="noopener">Clash</a>, a new software that is quite the same to <a href="https://www.nssurge.com" target="_blank" rel="noopener">Surge</a>. They both support “rules” mode that routes internet traffic on your will. It’s so convenient that you don’t have to use <em>gfwlist</em> anymore, and they are more precise and customizable, like you can route Google to a Hong Kong proxy, YouTube to United States, Netflix to Japan and so forth. Clash also has a <em>redir</em> mode which can be used with <em>iptables</em> to redirect the TCP packets. We’re also gonna utilize <a href="https://www.nlnetlabs.nl/projects/unbound" target="_blank" rel="noopener">Unbound</a> and <a href="https://github.com/jedisct1/dnscrypt-proxy" target="_blank" rel="noopener">DNSCrypt-proxy</a> to solve the DNS pollution issue.</p><h1 id="Download-the-tools"><a href="#Download-the-tools" class="headerlink" title="Download the tools"></a>Download the tools</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir /etc/clash</span><br><span class="line">$ <span class="built_in">cd</span> /etc/clash</span><br><span class="line">$ wget https://github.com/Dreamacro/clash/releases/download/v0.13.0/clash-linux-amd64.tar.gz</span><br><span class="line">$ tar -xzvf clash-linux-amd64.tar.gz</span><br><span class="line">$ mv clash-linux-amd64 clash</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir /etc/unbound</span><br><span class="line">$ opkg update &amp;&amp; opkg install unbound</span><br></pre></td></tr></table></figure><p>Follow this guide to install DNSCrypt-proxy: <a href="https://github.com/jedisct1/dnscrypt-proxy/wiki/Installation-on-OpenWRT" target="_blank" rel="noopener">https://github.com/jedisct1/dnscrypt-proxy/wiki/Installation-on-OpenWRT</a></p><h1 id="Make-them-into-services"><a href="#Make-them-into-services" class="headerlink" title="Make them into services"></a>Make them into services</h1><p>Put the following script to <code>/etc/init.d/clash</code>:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh /etc/rc.common</span></span><br><span class="line"></span><br><span class="line">START=90</span><br><span class="line"></span><br><span class="line">USE_PROCD=1</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_service</span></span>() &#123;</span><br><span class="line">        procd_open_instance</span><br><span class="line">        procd_set_param <span class="built_in">command</span> /etc/clash/clash -d /etc/clash</span><br><span class="line">        procd_set_param respawn 300 0 5 <span class="comment"># threshold, timeout, retry</span></span><br><span class="line">        procd_set_param file /etc/clash/config.yml</span><br><span class="line">        procd_set_param stdout 1</span><br><span class="line">        procd_set_param stderr 1</span><br><span class="line">        procd_set_param pidfile /var/run/clash.pid</span><br><span class="line">        procd_close_instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then run the following to make it executable:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ chmod +x /etc/init.d/clash</span><br></pre></td></tr></table></figure><p>This init.d script also immediately restarts clash when it exits for whatever reason. If it crashes 5 times in 5 minutes, it won’t be restarted anymore.</p><p>The logs are in <code>/var/log/messages</code>.</p><h1 id="Write-Clash-Configuration"><a href="#Write-Clash-Configuration" class="headerlink" title="Write Clash Configuration"></a>Write Clash Configuration</h1><p>I’m not covering how to write Clash configuration in this blog post, but these options must be set as follows:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">redir-port:</span> <span class="number">9090</span></span><br><span class="line"><span class="attr">allow-lan:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">external-controller:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:6170</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line"><span class="attr">  enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  ipv6:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  listen:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:53</span></span><br><span class="line"><span class="attr">  enhanced-mode:</span> <span class="string">redir-host</span></span><br><span class="line"><span class="attr">  nameserver:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5353</span></span><br></pre></td></tr></table></figure><p>Let’s tear it down. <code>9090</code> is the redir port, <code>allow-lan</code> allows other devices in LAN to access the proxy and <code>external-controller</code> is the API that we’re gonna use later to control Clash.</p><p>Clash will now forward DNS requests from <code>:53</code> to <em>unbound</em> (<code>:5353</code>), which forwards DNS requests to <em>DNSCrypt-proxy</em> (<code>:5678</code>). <em>DNSCrypt-proxy</em> will then securely get the correct DNS responses using <a href="https://en.wikipedia.org/wiki/DNS_over_HTTPS" target="_blank" rel="noopener">DoH</a>.</p><h1 id="Configure-dnsmasq"><a href="#Configure-dnsmasq" class="headerlink" title="Configure dnsmasq"></a>Configure dnsmasq</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Disable dnsmasq DNS server</span></span><br><span class="line">$ uci <span class="built_in">set</span> <span class="string">'dhcp.@dnsmasq[0].port=0'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure dnsmasq to send a DNS Server DHCP option with its LAN IP</span></span><br><span class="line"><span class="comment"># since it does not do this by default when port is configured.</span></span><br><span class="line">$ lan_address=$(uci get network.lan.ipaddr)</span><br><span class="line">$ uci add_list <span class="string">"dhcp.lan.dhcp_option=option:dns-server,<span class="variable">$lan_address</span>"</span></span><br><span class="line"></span><br><span class="line">$ uci commit</span><br></pre></td></tr></table></figure><h1 id="Configure-DNSCrypt-proxy"><a href="#Configure-DNSCrypt-proxy" class="headerlink" title="Configure DNSCrypt-proxy"></a>Configure DNSCrypt-proxy</h1><p>Use the example config with these options changed:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server_names = [<span class="string">'cloudflare'</span>, <span class="string">'google'</span>]</span><br><span class="line">listen_addresses = [<span class="string">'0.0.0.0:5678'</span>]</span><br><span class="line">fallback_resolver = <span class="string">'119.29.29.29:53'</span></span><br><span class="line">ignore_system_dns = <span class="literal">true</span></span><br><span class="line">forwarding_rules = <span class="string">'forwarding-rules.txt'</span></span><br></pre></td></tr></table></figure><h1 id="Configure-Unbound"><a href="#Configure-Unbound" class="headerlink" title="Configure Unbound"></a>Configure Unbound</h1><p>First download <em>named.cache</em> from InterNIC:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget ftp://FTP.INTERNIC.NET/domain/named.cache -O/etc/unbound/root.hints</span><br></pre></td></tr></table></figure><p>Then enable manual config so we can configure <em>Unbound</em> directly using it’s config file:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ uci <span class="built_in">set</span> <span class="string">'unbound.@unbound[0].manual_conf=1'</span></span><br></pre></td></tr></table></figure><p>To make China domains solve through <code>119.29.29.29</code> instead of foreign <em>DNSCrypt-proxy</em>, we’re using <a href="https://github.com/felixonmars/dnsmasq-china-list.git" target="_blank" rel="noopener">https://github.com/felixonmars/dnsmasq-china-list</a>.</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/felixonmars/dnsmasq-china-list.git</span><br><span class="line">$ <span class="built_in">cd</span> dnsmasq-china-list</span><br><span class="line">$ make SERVER=119.29.29.29 unbound</span><br><span class="line">$ mkdir /etc/unbound/unbound.conf.d</span><br><span class="line">$ cp accelerated-domains.china.unbound.conf /etc/unbound/unbound.conf.d</span><br></pre></td></tr></table></figure><p>Finally, this is the config I’m currently using:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">include:</span> <span class="string">"/etc/unbound/unbound.conf.d/accelerated-domains.china.unbound.conf"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="attr">verbosity:</span> <span class="number">1</span></span><br><span class="line">	<span class="attr">directory:</span> <span class="string">"/etc/unbound"</span></span><br><span class="line">	<span class="attr">num-threads:</span> <span class="number">2</span></span><br><span class="line">	<span class="attr">msg-cache-slabs:</span> <span class="number">1</span></span><br><span class="line">	<span class="attr">rrset-cache-slabs:</span> <span class="number">1</span></span><br><span class="line">	<span class="attr">infra-cache-slabs:</span> <span class="number">1</span></span><br><span class="line">	<span class="attr">key-cache-slabs:</span> <span class="number">1</span></span><br><span class="line">	<span class="attr">interface:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">	<span class="attr">access-control:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span> <span class="string">allow</span></span><br><span class="line">	<span class="attr">outgoing-num-tcp:</span> <span class="number">256</span></span><br><span class="line">	<span class="attr">incoming-num-tcp:</span> <span class="number">1024</span></span><br><span class="line">	<span class="attr">outgoing-port-permit:</span> <span class="string">"10240-65335"</span></span><br><span class="line">	<span class="attr">outgoing-range:</span> <span class="number">60</span></span><br><span class="line">	<span class="attr">num-queries-per-thread:</span> <span class="number">30</span></span><br><span class="line">	<span class="attr">msg-buffer-size:</span> <span class="number">8192</span></span><br><span class="line">	<span class="attr">infra-cache-numhosts:</span> <span class="number">200</span></span><br><span class="line">	<span class="attr">key-cache-size:</span> <span class="number">100</span><span class="string">k</span></span><br><span class="line">	<span class="attr">neg-cache-size:</span> <span class="number">10</span><span class="string">k</span></span><br><span class="line">	<span class="attr">target-fetch-policy:</span> <span class="string">"2 1 0 0 0 0"</span></span><br><span class="line">	<span class="attr">harden-large-queries:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">harden-short-bufsize:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">5353</span></span><br><span class="line">	<span class="attr">so-rcvbuf:</span> <span class="number">4</span><span class="string">m</span></span><br><span class="line">	<span class="attr">so-sndbuf:</span> <span class="number">4</span><span class="string">m</span></span><br><span class="line">	<span class="attr">so-reuseport:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">msg-cache-size:</span> <span class="number">64</span><span class="string">m</span></span><br><span class="line">	<span class="attr">rrset-cache-size:</span> <span class="number">128</span><span class="string">m</span></span><br><span class="line">	<span class="attr">cache-max-ttl:</span> <span class="number">3600</span></span><br><span class="line">	<span class="attr">do-ip4:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">do-ip6:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">do-udp:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">do-tcp:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">tcp-upstream:</span> <span class="literal">no</span></span><br><span class="line">	<span class="attr">use-syslog:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">log-queries:</span> <span class="literal">no</span></span><br><span class="line">	<span class="attr">root-hints:</span> <span class="string">"/etc/unbound/root.hints"</span></span><br><span class="line">	<span class="attr">hide-identity:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">hide-version:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">identity:</span> <span class="string">""</span></span><br><span class="line">	<span class="attr">version:</span> <span class="string">""</span></span><br><span class="line">	<span class="attr">harden-glue:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">private-address:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line">	<span class="attr">private-address:</span> <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span><span class="string">/12</span></span><br><span class="line">	<span class="attr">private-address:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">	<span class="attr">private-address:</span> <span class="number">169.254</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">	<span class="attr">private-address:</span> <span class="attr">fd00::/8</span></span><br><span class="line">	<span class="attr">private-address:</span> <span class="attr">fe80::/10</span></span><br><span class="line">	<span class="attr">private-address:</span> <span class="string">::ffff:0:0/96</span></span><br><span class="line">	<span class="attr">unwanted-reply-threshold:</span> <span class="number">10000000</span></span><br><span class="line">	<span class="attr">do-not-query-localhost:</span> <span class="literal">no</span></span><br><span class="line">	<span class="attr">prefetch:</span> <span class="literal">yes</span></span><br><span class="line">	<span class="attr">minimal-responses:</span> <span class="literal">no</span></span><br><span class="line">	<span class="attr">module-config:</span> <span class="string">"iterator"</span></span><br><span class="line"><span class="attr">forward-zone:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">"."</span></span><br><span class="line"><span class="attr">    forward-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">@5678</span></span><br></pre></td></tr></table></figure><h1 id="Launch-the-services"><a href="#Launch-the-services" class="headerlink" title="Launch the services"></a>Launch the services</h1><p>Run the following to make <em>Clash</em>, <em>DNScrypt-proxy</em> and <em>Unbound</em> launch at system startup:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ service clash <span class="built_in">enable</span></span><br><span class="line">$ service dnscrypt-proxy <span class="built_in">enable</span></span><br><span class="line">$ service unbound <span class="built_in">enable</span></span><br></pre></td></tr></table></figure><p>Apply the changes:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ service dnscrypt-proxy restart</span><br><span class="line">$ service unbound restart</span><br><span class="line">$ service clash restart</span><br></pre></td></tr></table></figure><h1 id="Redirect-the-traffic-to-Clash"><a href="#Redirect-the-traffic-to-Clash" class="headerlink" title="Redirect the traffic to Clash"></a>Redirect the traffic to Clash</h1><p>Go to <code>https://ROUTER_IP/cgi-bin/luci/admin/network/firewall/custom</code>, append the following to the end of rules. <strong>Be aware that you need to change <code>YOUR_SSH_PORT</code>.</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">iptables -t nat -N clash_lan</span><br><span class="line">iptables -t nat -A clash_lan -d 0.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t nat -A clash_lan -d 10.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t nat -A clash_lan -d 127.0.0.0/8 -j RETURN</span><br><span class="line">iptables -t nat -A clash_lan -d 169.254.0.0/16 -j RETURN</span><br><span class="line">iptables -t nat -A clash_lan -d 172.16.0.0/12 -j RETURN</span><br><span class="line">iptables -t nat -A clash_lan -d 192.168.0.0/16 -j RETURN</span><br><span class="line">iptables -t nat -A clash_lan -d 224.0.0.0/4 -j RETURN</span><br><span class="line">iptables -t nat -A clash_lan -d 240.0.0.0/4 -j RETURN</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable the proxy for 10.0.0.123</span></span><br><span class="line"><span class="comment"># iptables -t nat -A clash_lan -s 10.0.0.123 -j RETURN</span></span><br><span class="line"></span><br><span class="line">iptables -t nat -A clash_lan -p tcp --dport YOUR_SSH_PORT -j ACCEPT</span><br><span class="line">iptables -t nat -A clash_lan -p tcp --dport 80 -j REDIRECT --to-ports 9090</span><br><span class="line">iptables -t nat -A clash_lan -p tcp --dport 443 -j REDIRECT --to-ports 9090</span><br><span class="line">iptables -t nat -A clash_lan -p tcp --dport 53 -j REDIRECT --to-ports 53</span><br><span class="line"></span><br><span class="line">iptables -t nat -A PREROUTING -p tcp -j clash_lan</span><br><span class="line"></span><br><span class="line"><span class="comment"># Chromecast</span></span><br><span class="line">iptables -t nat -A PREROUTING -s IP_CIDR_OF_CHROMECAST_IF_YOU_HAVE_ANY -p udp --dport 53 -j REDIRECT --to-ports 53</span><br><span class="line">iptables -t nat -A PREROUTING -s IP_CIDR_OF_CHROMECAST_IF_YOU_HAVE_ANY -p tcp --dport 53 -j REDIRECT --to-ports 53</span><br></pre></td></tr></table></figure><p>You can now open your browser now and go to <code>https://ipinfo.io</code> to see if it works!</p><h1 id="Control-Clash"><a href="#Control-Clash" class="headerlink" title="Control Clash"></a>Control Clash</h1><p>Remember <code>external-controller</code>? We’re gonna make use of it… right now.</p><p>There’s a fantastic web interface that does exactly the work: <a href="http://clash.razord.top/" target="_blank" rel="noopener">http://clash.razord.top/</a>. Use your OpenWrt IP address, and port <code>6170</code>.</p><p>Be ware that Clash does <em>not</em> remember your choices of servers between restarts.</p><h1 id="Check-the-logs"><a href="#Check-the-logs" class="headerlink" title="Check the logs"></a>Check the logs</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ logread -e clash -f</span><br></pre></td></tr></table></figure><h1 id="Last-words"><a href="#Last-words" class="headerlink" title="Last words"></a>Last words</h1><p>I’m also using WireGuard to connect back to my home network when I’m not in house. If you want to know further more how to configure WireGuard to work with this approach (Clash + Unbound), comment down below.</p><h1 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h1><ul><li><a href="https://github.com/Dreamacro/clash" target="_blank" rel="noopener">https://github.com/Dreamacro/clash</a></li><li><a href="https://blog.phoenixlzx.com/2016/04/27/better-dns-with-unbound/" target="_blank" rel="noopener">https://blog.phoenixlzx.com/2016/04/27/better-dns-with-unbound/</a></li><li><a href="https://github.com/SukkaW/Koolshare-Clash" target="_blank" rel="noopener">https://github.com/SukkaW/Koolshare-Clash</a></li><li><a href="https://openwrt.org/docs/guide-user/services/dns/unbound" target="_blank" rel="noopener">https://openwrt.org/docs/guide-user/services/dns/unbound</a></li></ul></article><p class="post-footer-info mb-0 pt-0">Published at&nbsp;<time datetime="2019-01-18T18:49:55.000Z" itemprop="datePublished">January 19th 2019</time>, updated at&nbsp;<time datetime="2020-02-20T13:04:37.064Z" itemprop="dateModified">February 20th 2020</time> .</p><p class="post-footer-info mb-0 pt-2"></p></div><div class="post-nav px-2 bg-gray"><ul class="pagination"><li class="page-item page-prev"><a href="/Setting-up-a-WireGuard-server-on-OpenWRT/"><div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div><div class="page-item-subtitle">Setting up a WireGuard server on OpenWRT</div></a></li><li class="page-item page-next"><a href="/Change-GRUB-timeout-in-OpenWrt-to-speed-up-boot-process/"><div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div><div class="page-item-subtitle">Change GRUB timeout in OpenWrt to speed up boot process</div></a></li></ul></div><div class="card-footer post-comment"><div id="disqus_thread"></div><script src="https://cdn.jsdelivr.net/npm/disqusjs@1.0.6/dist/disqus.js"></script><script>var dsqjs=new DisqusJS({shortname:"birkhoff",identifier:"https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/",url:"https://blog.birkhoff.me/Running-Clash-on-OpenWrt-as-a-transparent-proxy/",api:"",apikey:"k71pSDWqRW7T6zNLNcz2h9gEc3AuWTO5bwIjy02UJWfCO8GlPUiGQt9vb6SiDVtP",admin:"birkhofflee"})</script></div></div></div></div></div><footer class="text-center"><p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span data-year=""></span> <a class="footer-copyright-a" href="https://blog.birkhoff.me">Birkhoff&#39;s Blog</a></p><p class="footer-text mb-0"></p><p class="footer-develop mb-0">Powered by&nbsp;<a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="noopener">Suka</a></p></footer><script>window.lazyLoadOptions={elements_selector:".lazyload",threshold:50};var copyrightNow=(new Date).getFullYear(),copyrightContent=document.querySelector("span[data-year]");copyrightSince=2015,copyrightSince===copyrightNow?copyrightContent.textContent=copyrightNow:copyrightContent.textContent=copyrightSince+" - "+copyrightNow,console.log("\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.0 %c https://github.com/SukkaW/hexo-theme-suka \n","color: #fff; background: #444; padding:5px 0;","background: #bbb; padding:5px 0;")</script><script src="/lib/vanilla-lazyload/lazyload.min.js" async></script></body></html>